<div id="feedback-widget" class="feedback-widget" style="display: none;">
    <div class="feedback-header">
        <h4>Wie hilfreich war diese Antwort?</h4>
        <button class="close-feedback" onclick="hideFeedbackWidget()">&times;</button>
    </div>
    
    <div class="feedback-content">
        <!-- Sterne-Bewertung -->
        <div class="rating-section">
            <div class="stars">
                <span class="star" data-rating="1" onclick="setRating(1)">‚òÖ</span>
                <span class="star" data-rating="2" onclick="setRating(2)">‚òÖ</span>
                <span class="star" data-rating="3" onclick="setRating(3)">‚òÖ</span>
                <span class="star" data-rating="4" onclick="setRating(4)">‚òÖ</span>
                <span class="star" data-rating="5" onclick="setRating(5)">‚òÖ</span>
            </div>
            <div class="rating-text" id="rating-text">Bewerten Sie die Antwort</div>
        </div>
        
        <!-- Schnelle Bewertungen -->
        <div class="quick-feedback">
            <button class="quick-btn helpful" onclick="setQuickFeedback('helpful')">
                üëç Hilfreich
            </button>
            <button class="quick-btn not-helpful" onclick="setQuickFeedback('not_helpful')">
                üëé Nicht hilfreich
            </button>
            <button class="quick-btn more-info" onclick="setQuickFeedback('more_info')">
                ‚ÑπÔ∏è Mehr Info
            </button>
        </div>
        
        <!-- Spezifisches Feedback -->
        <div class="specific-feedback">
            <textarea id="specific-feedback" placeholder="Geben Sie uns spezifisches Feedback f√ºr Verbesserungen..."></textarea>
        </div>
        
        <!-- Submit Button -->
        <div class="feedback-actions">
            <button class="submit-feedback" onclick="submitFeedback()">
                Feedback senden
            </button>
        </div>
    </div>
</div>

<style>
.feedback-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    font-family: Arial, sans-serif;
}

.feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    border-radius: 8px 8px 0 0;
}

.feedback-header h4 {
    margin: 0;
    color: #333;
    font-size: 16px;
}

.close-feedback {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #666;
}

.close-feedback:hover {
    color: #333;
}

.feedback-content {
    padding: 20px;
}

.rating-section {
    text-align: center;
    margin-bottom: 20px;
}

.stars {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
}

.star {
    transition: color 0.2s;
}

.star:hover,
.star.active {
    color: #ffd700;
}

.rating-text {
    margin-top: 8px;
    font-size: 14px;
    color: #666;
}

.quick-feedback {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.quick-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.quick-btn:hover {
    background: #f8f9fa;
}

.quick-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.specific-feedback {
    margin-bottom: 20px;
}

#specific-feedback {
    width: 100%;
    height: 80px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    font-family: inherit;
}

.feedback-actions {
    text-align: center;
}

.submit-feedback {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.submit-feedback:hover {
    background: #0056b3;
}

.submit-feedback:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.feedback-success {
    color: #28a745;
    font-size: 14px;
    text-align: center;
    margin-top: 10px;
}

.feedback-error {
    color: #dc3545;
    font-size: 14px;
    text-align: center;
    margin-top: 10px;
}
</style>

<script>
let currentRating = 0;
let currentQuickFeedback = '';
let currentInteractionId = '';

function showFeedbackWidget(interactionId) {
    currentInteractionId = interactionId;
    document.getElementById('feedback-widget').style.display = 'block';
    resetFeedback();
}

function hideFeedbackWidget() {
    document.getElementById('feedback-widget').style.display = 'none';
    resetFeedback();
}

function resetFeedback() {
    currentRating = 0;
    currentQuickFeedback = '';
    
    // Reset stars
    document.querySelectorAll('.star').forEach(star => {
        star.classList.remove('active');
    });
    
    // Reset quick feedback buttons
    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Reset textarea
    document.getElementById('specific-feedback').value = '';
    
    // Reset rating text
    document.getElementById('rating-text').textContent = 'Bewerten Sie die Antwort';
    
    // Remove success/error messages
    const successMsg = document.querySelector('.feedback-success');
    const errorMsg = document.querySelector('.feedback-error');
    if (successMsg) successMsg.remove();
    if (errorMsg) errorMsg.remove();
}

function setRating(rating) {
    currentRating = rating;
    
    // Update stars
    document.querySelectorAll('.star').forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
    
    // Update rating text
    const ratingTexts = [
        'Sehr schlecht',
        'Schlecht', 
        'Okay',
        'Gut',
        'Sehr gut'
    ];
    document.getElementById('rating-text').textContent = ratingTexts[rating - 1] || 'Bewerten Sie die Antwort';
}

function setQuickFeedback(type) {
    currentQuickFeedback = type;
    
    // Update button states
    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
}

function submitFeedback() {
    const specificFeedback = document.getElementById('specific-feedback').value;
    
    // Validate feedback
    if (!currentRating && !currentQuickFeedback) {
        showFeedbackMessage('Bitte geben Sie eine Bewertung ab.', 'error');
        return;
    }
    
    // Prepare feedback data
    const feedbackData = {
        interaction_id: currentInteractionId,
        rating: currentRating || 3,
        helpful: currentQuickFeedback === 'helpful',
        follow_up_needed: currentQuickFeedback === 'more_info',
        specific_feedback: specificFeedback,
        user_id: 'anonymous'
    };
    
    // Send feedback to server
    fetch('/api/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(feedbackData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFeedbackMessage('Vielen Dank f√ºr Ihr Feedback!', 'success');
            setTimeout(() => {
                hideFeedbackWidget();
            }, 2000);
        } else {
            showFeedbackMessage('Fehler beim Senden des Feedbacks.', 'error');
        }
    })
    .catch(error => {
        console.error('Feedback error:', error);
        showFeedbackMessage('Fehler beim Senden des Feedbacks.', 'error');
    });
}

function showFeedbackMessage(message, type) {
    // Remove existing messages
    const existingMsg = document.querySelector('.feedback-success, .feedback-error');
    if (existingMsg) existingMsg.remove();
    
    // Create new message
    const msgDiv = document.createElement('div');
    msgDiv.className = `feedback-${type}`;
    msgDiv.textContent = message;
    
    // Insert after feedback actions
    const actionsDiv = document.querySelector('.feedback-actions');
    actionsDiv.appendChild(msgDiv);
}

// Auto-hide feedback widget after 30 seconds
let feedbackTimeout;
function startFeedbackTimeout() {
    feedbackTimeout = setTimeout(() => {
        hideFeedbackWidget();
    }, 30000);
}

function clearFeedbackTimeout() {
    if (feedbackTimeout) {
        clearTimeout(feedbackTimeout);
    }
}

// Start timeout when widget is shown
document.addEventListener('DOMContentLoaded', function() {
    const widget = document.getElementById('feedback-widget');
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (widget.style.display === 'block') {
                    startFeedbackTimeout();
                } else {
                    clearFeedbackTimeout();
                }
            }
        });
    });
    
    observer.observe(widget, { attributes: true });
});
</script> 
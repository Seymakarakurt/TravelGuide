<div id="feedback-widget" class="feedback-widget" style="display: none;">
    <div class="feedback-header">
        <h4>Wie hilfreich war diese Antwort?</h4>
        <button class="feedback-close" onclick="hideFeedbackWidget()">&times;</button>
    </div>
    
    <div class="feedback-content">
        <div class="rating-section">
            <div class="stars">
                <span class="star" data-rating="1" onclick="setRating(1)">★</span>
                <span class="star" data-rating="2" onclick="setRating(2)">★</span>
                <span class="star" data-rating="3" onclick="setRating(3)">★</span>
                <span class="star" data-rating="4" onclick="setRating(4)">★</span>
                <span class="star" data-rating="5" onclick="setRating(5)">★</span>
            </div>
            <p class="rating-text">Bewerten Sie die Antwortqualität</p>
        </div>
        
        <div class="quick-feedback">
            <button class="feedback-btn helpful" onclick="setQuickFeedback('helpful', true)">
                Hilfreich
            </button>
            <button class="feedback-btn not-helpful" onclick="setQuickFeedback('helpful', false)">
                Nicht hilfreich
            </button>
            <button class="feedback-btn follow-up" onclick="setQuickFeedback('follow_up', true)">
                Brauche mehr Info
            </button>
        </div>
        
        <div class="specific-feedback">
            <textarea id="specific-feedback" placeholder="Teilen Sie uns mit, was wir verbessern können... (optional)"></textarea>
        </div>
        
        <div class="feedback-actions">
            <button class="submit-feedback" onclick="submitFeedback()">
                Feedback senden
            </button>
            <button class="skip-feedback" onclick="hideFeedbackWidget()">
                Überspringen
            </button>
        </div>
    </div>
</div>

<style>
.feedback-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    font-family: Arial, sans-serif;
}

.feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    border-radius: 8px 8px 0 0;
}

.feedback-header h4 {
    margin: 0;
    color: #333;
    font-size: 16px;
}

.feedback-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #666;
}

.feedback-close:hover {
    color: #333;
}

.feedback-content {
    padding: 20px;
}

.rating-section {
    text-align: center;
    margin-bottom: 20px;
}

.stars {
    font-size: 24px;
    margin-bottom: 10px;
}

.star {
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
}

.star:hover,
.star.active {
    color: #ffd700;
}

.rating-text {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.quick-feedback {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.feedback-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.feedback-btn:hover {
    background: #f8f9fa;
}

.feedback-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.specific-feedback {
    margin-bottom: 20px;
}

.specific-feedback textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    font-family: inherit;
}

.feedback-actions {
    display: flex;
    gap: 10px;
}

.submit-feedback,
.skip-feedback {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.submit-feedback {
    background: #007bff;
    color: white;
}

.submit-feedback:hover {
    background: #0056b3;
}

.skip-feedback {
    background: #6c757d;
    color: white;
}

.skip-feedback:hover {
    background: #545b62;
}

/* Animation */
.feedback-widget {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>

<script>
let currentRating = 0;
let currentFeedback = {
    helpful: null,
    follow_up: false
};
let currentInteractionId = null;

function showFeedbackWidget(interactionId) {
    currentInteractionId = interactionId;
    document.getElementById('feedback-widget').style.display = 'block';
    resetFeedback();
}

function hideFeedbackWidget() {
    document.getElementById('feedback-widget').style.display = 'none';
    resetFeedback();
}

function resetFeedback() {
    currentRating = 0;
    currentFeedback = { helpful: null, follow_up: false };
    
    // Reset stars
    document.querySelectorAll('.star').forEach(star => {
        star.classList.remove('active');
    });
    
    // Reset buttons
    document.querySelectorAll('.feedback-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Reset textarea
    document.getElementById('specific-feedback').value = '';
}

function setRating(rating) {
    currentRating = rating;
    
    // Update stars
    document.querySelectorAll('.star').forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

function setQuickFeedback(type, value) {
    if (type === 'helpful') {
        currentFeedback.helpful = value;
        // Update button states
        document.querySelectorAll('.feedback-btn.helpful, .feedback-btn.not-helpful').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    } else if (type === 'follow_up') {
        currentFeedback.follow_up = value;
        event.target.classList.toggle('active');
    }
}

function submitFeedback() {
    if (!currentInteractionId) {
        console.error('Keine Interaction ID verfügbar');
        return;
    }
    
    const specificFeedback = document.getElementById('specific-feedback').value;
    
    const feedbackData = {
        interaction_id: currentInteractionId,
        rating: currentRating,
        helpful: currentFeedback.helpful,
        follow_up_needed: currentFeedback.follow_up,
        specific_feedback: specificFeedback
    };
    
    // Sende Feedback an Backend
    fetch('/api/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(feedbackData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Feedback erfolgreich gesendet');
            hideFeedbackWidget();
            showFeedbackThankYou();
        } else {
            console.error('Fehler beim Senden des Feedbacks:', data.error);
        }
    })
    .catch(error => {
        console.error('Fehler beim Senden des Feedbacks:', error);
    });
}

function showFeedbackThankYou() {
    // Zeige kurze Bestätigung
    const thankYou = document.createElement('div');
    thankYou.className = 'feedback-thank-you';
    thankYou.innerHTML = 'Vielen Dank für Ihr Feedback!';
    thankYou.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        z-index: 1001;
        animation: fadeIn 0.3s ease-out;
    `;
    
    document.body.appendChild(thankYou);
    
    setTimeout(() => {
        thankYou.remove();
    }, 3000);
}

// Event Listener für Sterne-Hover
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star');
    
    stars.forEach((star, index) => {
        star.addEventListener('mouseenter', function() {
            stars.forEach((s, i) => {
                if (i <= index) {
                    s.style.color = '#ffd700';
                }
            });
        });
        
        star.addEventListener('mouseleave', function() {
            stars.forEach((s, i) => {
                if (!s.classList.contains('active')) {
                    s.style.color = '#ddd';
                }
            });
        });
    });
});
</script> 